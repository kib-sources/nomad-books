# User Case-ы




## Появление нового пользователя

1. Пользователь c ролью `leader` (далее **лидер**) 
или c более высокой ролью 
очным образом узнаёт телеграм-имя нового пользователя (далее **пользователь**).
1. **Лидер** нажимает в приложении `добавить пользователя`
2. **Лидер** вводит телеграмм-имя
3. **Пользователь** заходит в телеграмм-бота. 
4. Телеграмм-бот даёт **инвайт-токен** и ссылку на актуальную версию приложения
5. **Пользователь** устанавливает приложение
6. При первом старте приложения вводит **инвайт-токен**
7. **приложение** высылает запрос на сервер. Если токен валиден и если не прошёл таймаут, приложение авторизируется.


## Авторизация на новом устройстве

1. Пользватель пишет чат-боту
2. Чат-бот прекращает подписку старого приложения (если есть) и высылает новый **инвайт-токен** и ссылку на актуальное приложение
3. Если пользователь ещё не установил приложение , пользователь устанавливает приложение
4. При первом старте приложения вводит **инвайт-токен**

## Регистрация новой книги

1. Пользователь с ролью `admin` (далее **админ**)
или c более высокой ролью 
нажимает на `регистрация книги (описание)`
2. Админ вводит все параметры для книги
3. Нажимает `сохранить`. Получает `id` книги

## Регистрация нового экземпляра книги

1. Пользователь с ролью `admin` (далее **админ**) 
или c более высокой ролью 
нажимает на `регистрация экземпляра книги`
2. Админ вводит `id` книги и другие параметры для экзземпляра
3. Админ нажимает `сохранить`
4. Телеграмм-бот присылает изображение с QR кодом + uuid экземпляра книги
5. Админ печатает это изображение на специальной клейкой бумаге
6. Админ физически наклеивает QR код
7. Админ проставляет печати на заглавной, 17-й и 239 (если есть) странице
8. Админ проверяет книгу по QR коду

## Чтение QR книги

1. Пользователь открывает приложение и нажимает `сканировать книгу`
2. Фотографирует QR
3. Получает информацию о книге, об экземпляре книге, о текущем владельце.
4. Есть кнопка `забрать книгу`

## Поиск книги

Возможно разные варианты поиска:
* по текстовому произвольному запросу
* по like запросу текстовых полей: 
  1. название книги
  2. имя одного из авторов
  3. год издания

1. Пользователь в приложении нажимает `поиск`
2. Вводит параметры поиска
3. Получает список книг в порядке релевантности
4. (опционально) Любую книгу пользователь может добавить в `Избранное`
5. Пользователь нажимает на книгу и видит экземпляры книги (см. ниже)


## Просмотр экземпляра книги и затребование

1. Либо из вкладки "Избранное", либо через поиск пользователь нажимает на книгу и видит экземпляры книги
2. Экземпляры книги упорядоченны:
   1. сначала пользователь видит книги со статусом "свободна"
   2. потом видит книги в порядке их времени хранения у последнего владельца
   3. если книга у владельца меньше допустимого времени владения, или если у них статус `active_reading`, то для этих книг кнопка "затребовать" недоступна
3. Пользователь может выбрать на любую из строк и нажать кнопку "затребовать"
4. Бот пишет владельцу книги, кто и какую книгу у него затребовал
5. Бот пишет новому владельцу
6. Новый владелец пишет владельцу в Telegram
7. Происходит очная встреча
8. С помощью приложения новый владелец сканирует QR код
9. Бот пишет новому владельцу, что теперь он владелец книги
10. Бот пишет старому владельцу, что теперь он не владелец книги


## Отмена затребования

Если по каким-либо причинам встреча не происходит, 
новый владелец имеет права пожаловатся админам
или 
отменить затребование

Если отменяется затребование:
1. В приложении пользователь нажимает на вкладку `затребованные книги мной`
2. Ищет по телеграмм-имени и по названию книги нужную
3. Нажимает `отменить затребование`
4. Телеграм-бот пишет владельцу, что книга не затребована
5. Телеграм-бот пишет пользвателю, что книга ушла из затребованной


## Просмотр всех физических книг, которые на руках у пользователя

В приложении есть кнопка `Мои книги`

## Просмотр всех затребованных книг

В приложении есть кнопки:
1. `затребованные книги мной`
1. и `звтребованные книги другими участниками`.

Если нет затребованных книг какой-либо категории, то enabled=false.

## Поставить статус книге

В `Мои книги` есть кнопки:
1. `присвоить статус "свободна"`
1. `присвоить статус "в активном чтении"`
1. `присвоить статус "читаю"`

Если книга в `активном чтении`, то в течении 48 часов её нельзя затребовать.
Кнопку `присвоить статус "в активном чтении"` можно нажать повторно через 12 часов.


## Забрать книгу

1. Два пользователя: старый владелец и будущий новый владелец книги встречаются в очном формате
2. Новый владелец сканирует QR код (см. *Чтение QR книги*)
3. Новый владелец нажимает `забрать книгу`
4. В зависимости от статуса книги:
    1. Если книга в статусе `свободна` или `затребована` -- оунер меняется автоматически
    2. Если книга в статусе `в активном чтении` -- всплывает ошибка. Конец алгоритма.
    3. Иначе 
        1. старому владельцу в чат-боте вспливает окно "Пользователь <Telegram-имя> хочет забрать у вас книгу <название книги>"
        2. старый владелец нажимает кнопку `ок`
        3. меняется владелец книги
5. Чат бот пишет старому владельцу, что книга отдана
6. Чат бот пишет новому владельцу, что теперь на его ответственности новая книга