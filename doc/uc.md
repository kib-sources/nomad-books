# User Case-ы

Роли:
* **user** -- обычная роль простого пользователя Кочевой библиотеки
* **leader** -- лидер. Роль, позволяющая добавлять новых пользователей
* **admin** -- администратор. Может вносить новые книги в систему
* **developer** -- разработчик Кочевой Библиотеки. Может менять роли
* **owner** -- один единственный пользователь в Telegram. Равен председателю правления в КИБ-е



## Появление нового пользователя

1. Пользователь с ролью `leader` (далее А) и новый пользователь (далее Б) очно встречаются
   * Регистрация нового пользователя без очного присутствия не разрешается в рамках "джентельменского соглашения".
2. Пользователь А в чат-боте ввотит команду `/new-user`
3. Вводит `@username` нового пользователя. 
4. В базе даных появляется новая строка со статусом `init`.
5. Новый пользователь Б с именем `@username` вводит команду `/start` Чат-боту.
   * Если в течении 20 минут не выполнен этот пункт -- пользователь не регистрируется. 
   * Если нет предыдыдущих пунктов, то чат-бот игнорирует команду `/start`.
6. Статус нового пользователя переводится в статуc `active`. Его Telegram ID и `@username` записываются в БД.
7. Новый пользователь получает сообщение 1
8. Пользователь А получает сообщение 2


**Сообщение 1:**
```text
Здравствуйте @username!
@Пользователь_А вас зарегестрировал 
в Кочевой Библиотеке "Клуба Информационной Безопасности"

**Пройдите инструктаж:**
-- устно от пользователя @Пользователь_А
-- ознакомьтесь с инструкцией: <ссылка на инструкцию>

Введите команду /help для взаимодействия с чат-ботом.
```


**Сообщение 2:**
```text
Пользователь @username зарегистрирован в системе!

Пожалуйста, проведите устный очный инструктаж.
(если вы ещё его не провели)
```

## Появление новой книги и экземпляра книги

Одна и та же книга может иметь более одного экземпляра, поэтому:
* `desctiption` -- описание новой книги
* `sample` -- описание нового ЭКЗЕМПЛЯРА книги


### Появление новой книги

1. Пользователь с ролью `admin` или вводит команду в чат-боте `/new-description`
2. Создаётся новая запись в `description` со статусом `init`
    * Если в течении 1 часа нет никаких изменений -- запись удаляется.
3. Чат-бот последовательно просить ввести текст \ отрпавить изображение:
   1. Название книги
   2. Тип
        * книга
        * журнал
        * брошюра
   3. (для журнала) -- номер.
   4. (для книги) -- номер издания или пустая строка
   5. Жанр (можно выбрать несколько)
       * ИБ
       * IT
       * математика
       * научпоп
       * физика
       * худлит
       * другое
   6. Если выбрал другое, нужно через запятую дополнить.
   7. Год издания
   8. Авторы
   9. Место (Страна, город)
   10. Издательство
   11. Краткое описание
   12. Подробное описание
   13. Ключевые слова
   14. Оглавление
        * можно ввести "#" вначале -- это части
        * можно ввести "##" -- это подчасти к части
        * команда "/next" переход на следующий пункт.
   15. Фото обложки
   16. Фото заглавной страницы
   17. Другие фото (сколько угодно)
       * просто высылается фото
       * после фото можно сделать description текстом
       * команда "/next" переход на следующий пункт.
   18. 
4. Чат бот выводит всю информацию, которую ввёл пользователь
      * доступна кнопка "Done!"
      * доступна кнопка "Edit"
5. Пользователь нажимает "Done!". Статус меняется на `active`.
6. Пользователю сообщается UUID книги

### Появление новгого экзепляра книги

Нужно иметь клейкую бумагу и принтер.

1. Пользователь с ролью `admin` вводит команду `/new-sample`
2. Пользователь вводит UUID книги и количество экземпляров (далее N) книг
3. В базе данных в таблице `sample` появляются N экземпляров, привязанные к `/description`
4. Описание книги чат-бот выводит в чат с пользователем. Так же выводится изображения QR кодов в формате A4
   * Если пользователь ошибся, он может внести команду `/cansel`. 
5. Пользователь печатает, вырезает, наклеивает на книги
6. Каждую книгу пользователь фотографирует QR и высыает чат-боту.
   * на каждое корректное фото, `sample` статуса меняется на `active` и высылается сообщение 1.
   * если ввести команду `/cansel` на данном этапе, то удалятся экзепляры только со статусом `init`.
7. Все экзепляры закончены. Пользователю высылается сообщение 2.

Первый владелец книг тот кто их завёл.


**Сообщение 1:**
```text
Экземпляр книги усперно зарегестрирован.
Текущий статус `active`
UUID экземпляра: .....
```

**Сообщение 2:**
```text
Для книги <наименование>

Вы внесли все экземлпяры.

Всего <N> экземпляров

```

## Передача книги

1. Владелец книги (далее А) и новый пользователь (далее Б) очно встречаются. Книга даётся в руки новому владельцу
2. Б фотографирует QR и высылает его чат-боту
3. Чат-бот пишет Б сообщение 1. Б нажимает "ДА"
     * Если Б нажимает "НЕТ", то ничего не происходит. Конец алгоритма
4. Чат-бот пишет А сообщение 2. А нажимает "ДА"
     * Если А нажимает "НЕТ", то ничего не происходит.
5. Меняется владелец книги в системе. А получает сообщение 3, Б получает сообщение 4.

Сообщение 1
```text
Вы собираетесь у пользователя @username_A 
забрать книгу <НАЗВАНИЕ КНИГИ>
(UUID: ..., UUID экземпляра: ...)

Верно?
```

Сообщение 2
```text
Пользователь @username_Б
хочет забрать у вас книгу <НАЗВАНИЕ КНИГИ>.
(UUID: ..., UUID экземпляра: ...)

Вы её отдаёте?
```

Сообщение 3
```text
Вы отдали книгу <НАЗВАНИЕ КНИГИ> пользователю @username_Б
(UUID: ..., UUID экземпляра: ...)


Пожалуйсто, передайте физически книгу @username 
Теперь вы за неё не ответственны.
```

Сообщение 4
```text
Вы забрали у пользователя @username_А

Теперь вы за неё отвественны, 
пока не передадите её другому пользователю или администратору.

Не забудьте забрать физически книгу с собой!!!

Правила как хранить и заботится о книгах можно прочитать тут: ....

```

## Книги, за которые я отвественнен

1. Пользователь вводит команду `/mybooks`
2. Списком выдаются книги за которые он отвественнен

## Информация по книге + флаг "в активном чтении"

1. Пользователь берёт СВОЮ книгу, фотографирует QR и высылает его чат-боту
    * если пользователь берёт чужую книгу, то см. " Передача книги"
2. чат-бот высылает Сообщение 1
3. Пользователь нажимает кнопку "Флаг: в активном чтении"

```text
Эта ваша книга <НАЗВАНИЕ КНИГИ>

... <Подробное описание, и другие характеристики>



Если вам она более не нужна:
-- дайте тому, кто хочет её прочесть (если знаете кому)
-- отдайте её своему лидеру или администратору Кочевой Библиотеки.

Если вы данную книгу активно читаете и хотите временно исключить себя из
поиска, нажмите кнопку:
<КНОПКА: G>

```

## Пролонгирование "в активном чтении"

1. Раз в неделю чат-бот по всем книгам "в активном чтении" высылает пользователю сообщение 1 
    * Если пользователь нажал "ДА" -- продление на неделю 
    * Если пользлователь нажал "НЕТ" -- то флаг снимается. Экземпляр книги доступен в поиске

Сообщение 1
```text
Привет, @unsername.

Сейчас книга <НАЗВАНИЕ КНИГИ> 
находится с флагом "в активном чтении". 

Это значит что вы её читаете и она вам очень нужна. 

Это всё ещё так?
```


## Поиск книги

Нужно продумать грамотный поиск
Наверное нужно в Telegraph написать инстукцию и давать на неё сслыку
через `/help`

Возможные команды
* `/search <TEXT>` -- поиск по названию, ключевым словам, авторам,
* `/search-sample UUID` -- выдаёт все экзепляры по UUID книги + время владения каждым экзепляром
    * если книга с флагом "в активном чтении", то данные экземляры НЕ выводятся.
* `<UUID>` (если это UUID `description`) -- подробное описание книги
* `<UUID>` (если это UUID `sample`) -- подробное описание экзепляра книги + @username текущего владельца
* `/all-books --file` выдаёт сжатый .CSV файл с  `descripton` всех книг. Файл обновляется раз в сутки. Удобно для дальнейшего анализа


## Запрос книги

1. Нужно написать в телегу владельцу книги и встретится с ним
2. Далее см. "Передача книги"

## Книга потеряна

1. Нужно в базе данных руками поменять статус с `active` до `lose`

Как компенсировать это дело -- решается в очном порядке, на звонке или в переписке по Telegram.

-----

-----

##  (админ) Бекап данных

У нас нет сверхкритических данных, поэтому бекап данных можно сделать через... того же бота
(А почему и нет? Каковы риски?)

Сделать это может пользователь с ролью `developer`

1. Пользователь вводит команду `/backup --password <PASS>`
2. База данных копируется и высылается файлом. Файл зашифрован паролем <PASS>

Замечание: шифрование необходимо для удобства. 
Мы не знаем как дальше этот файл будет кочевать. 
Это защищает от человеческого фактора

Замечание по секьюрности:
-- мы и так работаем с Telegram, поэтому все транзакции видны командой Telegram



